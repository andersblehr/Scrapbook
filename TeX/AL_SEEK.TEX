%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -*- Mode: Latex -*- %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% al_seek.tex --- 
%%% Author          : blehr
%%% Created On      : Sun Mar 28 02:25:13 1993
%%% Last Modified By: blehr
%%% Last Modified On: Sun Apr  4 14:57:29 1993
%%% RCS revision    : $Revision$ $Locker$
%%% Status          : In writing....
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Finding a Pupil Point---The Swimming Octopus}
\label{algo:seek}

In this section, the {\em swimming octopus\/} search algorithm is
described.  As pointed out in the previous section, the aim of the
algorithm is to locate a point in a given image that unambigously can
be classified as a pupil point.  The reason for the name is that the
performance of the algorithm can be compared to an octopus looking for
the sea, as will become clear below.  The basic idea behind the
algorithm is described in Section~\ref{algo:seek:idea};
Section~\ref{algo:seek:octopus} introduces the {\em octopus\/} pixel
filter; in Section~\ref{algo:seek:IQ}, the ``intelligent'' octopus is
presented; in Section~\ref{algo:seek:strategy}, the overall {\em pick
  strategy\/} is described; and in Section~\ref{algo:seek:O}, the
overall number of operations required to detect the pupil is derived.
In the following, {\em the algorithm\/} is to be understood as the
swimming octopus search algorithm.

\subsection{The Basic Idea}
\label{algo:seek:idea}

\inserteps{landscap}{\label{fig:landscape}An image of the eye depicted
  as a three-dimensional landscape.}

The foundation of the algorithm is a variant of thresholding in which
all pixels with values (gray levels) below or equal to the threshold
value $T_{l}$ have their old values replaced by $T_{l}$, and all
pixels with values above $T_{l}$ retain their old values.  The effect
of applying thresholding of this sort to an image can be illustrated
by picturing the image as a three-dimensional landscape, as depicted
in Fig.~\ref{fig:landscape}.  The negative peaks correspond to the
aforementioned spots, whereas the positive peak in the left of the
image represents an actual bright point (compare
Fig.~\ref{fig:testimages}(b)).  When the image is thresholded, $T_{l}$
can be viewed as representing the surface level of a mostly
subterranean lake underneath this landscape.  Wherever the landscape
descends below $T_{l}$, this lake comes to the surface, forming
``ponds'' whose sizes depend on the extent of the corresponding
sub-lake portion of the landscape.  This is illustrated in
Fig.~\ref{fig:lake}.  Note that, although the pupil is hardly
discernable in Fig~\ref{fig:landscape}, it is clearly visible as
forming the largest pond, or {\em lake\/}, after thresholding.  Note
also that a number of relatively large lakes are formed by non-pupil
portions of the eye.  This form of thresholding will hereafter be
referred to as {\em lake-thresholding\/}.

The principle idea behind the search algorithm is that, bearing the
above notation in mind, every pixel in a given image can be classified
as being either {\em wet\/} or {\em dry\/}, wet pixels having values
below or equal to $T_{l}$, and dry pixels having values above $T_{l}$.
The advantage of this approach is that the darkest regions in the
image, of which the pupil is assumed to constitute the largest, are
assigned a unique value, $T_{l}$, which becomes {\em the\/} darkest
gray level of the thresholded image, whereas non-lake regions in the
image are left untouched.  Thus, sub-lake landscape features, which
characterize regions of which one is primarily interested in knowing
that they belong to the set of the darkest regions, are eliminated,
whereas the features of non-lake regions are preserved.  Using a wet
pixel as origin of operation (see Section~\ref{eval:approach:edge}),
for the moment not heeding whether or not this pixel is a pupil point,
it is clear that, in all directions, the first edge which is
encountered corresponds to either the {\em shore\/} of the lake of
which the pixel is a part, or to the shore of an {\em island\/} in
this lake.  Assuming that $T_{l}$ has been chosen so that the shores
of the {\em pupil lake\/} in an image correspond as closely as
possible to the actual pupil contour, and that the contrast of the
image is such that the pupil lake is relatively {\em deep\/}, thus
minimizing the probability of having islands in it, this approach
ensures minimum (zero) image noise between the origin of operation and
the pupil contour.

With images having as low contrast as the given test images,
particular care has to be taken when choosing $T_{l}$.  For the images
I have used during my thesis work, I found that $T_{l}=18$ ensures
``optimal'' pupil lakes and sufficiently small non-pupil lakes.
However, due to the low contrast, the probability of encountering
islands in the pupil lake is by no means ignorable.  $T_{l}=17$ tends
to make the image completely dry, whereas $T_{l}=19$ tends to
``drown'' large portions of it.  It is evident that, if the final
system were to employ equally low-contrasted images, only a small
change in light conditions would destroy this extremely frail balance.
However, employing a frame grabber supplying images whose gray levels
occupy a large portion of the desired gray level range (256) would by
and large eliminate this problem.

\inserteps{lake18}{\label{fig:lake}The image in
  Fig.~\protect\ref{fig:landscape} after thresholding with
  $T_{l}=18$.}

\subsection{Introducing the Octopus}
\label{algo:seek:octopus}

From the above, it is clear that the first requirement that an actual
pupil point has to satisfy in order to be recognized as such, is that
it be wet.  However, as is seen from Fig.~\ref{fig:lake}, the number
of wet non-pupil points in an image cannot be assumed to be zero.
Thus, to avoid classifying a non-pupil point as a pupil point, some
sort of neighbourhood filtering has to be done.  In
Section~\ref{eval:eval:segment} it was stated that, by means of
carefully thresholding the value resulting from some sort of
neighbourhood averaging, it is possible to design a pixel filter which
only lets points through that are actual pupil points.  In the
following, the pixel filter employed by the search algorithm is
described.

\subsubsection{The Octopus Pixel Filter}

The pupil lake is assumed to constitute the largest lake in an image
(if this is not the case, $T_{l}$ has been badly chosen).  Thus a point
can safely be classified as a pupil point if it is known to be part of
a lake whose size is in the order of the average pupil size.  More
precisely, the neighbourhood about the candidate pixel over which the
filtering is made must have a radius slightly smaller than the minimum
radius of the pupil.  

The pixel filter, hereafter referred to as the {\em octopus\/} (not to
be confused with {\octopus}, the name of the entire eye-tracking
algorithm), has the shape of a four-armed octopus as seen from above,
with its {\em arms\/} stretched in the {\em north\/}, {\em east\/},
{\em south\/} and {\em west\/} directions, respectively.  North is
defined to be upwards in the image.  See Fig.~\ref{fig:octopus}.  The
radius $r_{o}$ of the octopus (actually the length of its arms) is in
the current implementation set to be 80\% of the minimum pupil radius,
which, in the case of the given test images, is estimated to be
approximately 10\% of the horizontal image size.  The arms of the
octopus are viewed as consisting of {\em sensors\/}.  When applied at
a given location $(x,y)$ in an image, each sensor registers and
reports whether or not the pixel it covers is wet.  The {\em first
  swim-criterion\/} that has to be satisfied for the octopus to report
that it is (hence the name) {\em swimming\/}, that is, that it has
found the pupil lake, is that its central sensor, covering the pixel
at $(x,y)$, as well as its hands, that is, the outermost sensors of
each arm, report wetness.  If this requirement is satisfied, the
octopus starts to count how many of its sensors that report wetness.
If this number is higher than a given fraction $T_{s}$ of the total
number of sensors, the octopus is swimming and consequently reports
that the pixel at location $(x,y)$ represents a pupil point.  This
last requirement will be referred to as the {\em second
  swim-criterion\/}.

\insertepswidth{octopus}{\label{fig:octopus}The {\em octopus\/} pixel
  filter.  $r_{o}$ is its radius i pixels.}{0.33}

\subsubsection{Satisfying the Second Swim-Criterion}

The probability that the point which the octopus reports to be a pupil
point actually is a non-pupil point depends on the threshold value
$T_{s}$.  With low contrast images like the given test images, it is
often impossible to choose a value for $T_{l}$ which eliminates all
non-pupil lakes in the images.  Also, some of the non-pupil lakes may
be relatively large in comparison with the pupil lake, and have small
``ponds'' dispersed around them.  Thus there is a relatively large
probability of having the first swim-criterion satisfied outside the
pupil lake.  As a consequence, $T_{s}$ has to be chosen as high as
possible in order to minimize the probability of recognizing the
corresponding point as a pupil point.  Preferrably, $T_{s}$ should be
chosen near 1.  However, in such low-contrasted images, the number of
islands in the lakes, including the pupil lake, tends to be relatively
high, and thus choosing $T_{s}=1$ may cause no actual pupil points to
be recognized as such.  Accordingly, a balance has to be found.  With
the given test images, I found that $T_{s}=0.8$ caused no non-pupil
points to be returned, whereas lower values for some images caused the
recognition of non-pupil points as pupil points.  Values of 0.9 or
higher caused no pupil points to be recognized in some of the images.

A point which requires some elaboration is that, with the given test
images, lower values for $T_{s}$ made the search algorithm run faster.
This can be attributed to the poor image quality, and in particular to
the low contrast.  The average gray level of the pupil lakes in the
images was found to be 17, making the average depth of any pupil lake
1 (given that $T_{l}=18$).  Thus local variations in the pupil with
positive amplitudes of 2 and more cause islands to appear in the pupil
lake.  Hence, if the octopus actually {\em is\/} in the pupil sea, the
probability that one or more of its arms cross at least one island,
thus reducing the number of sensors reporting wetness, is relatively
large.  Accordingly, the probability $p$ that the second
swim-criterion will not be satisfied at a given location is higher
than it would be if there were none or few islands in the pupil lake.
Evidently, $p$ is inversly proportional to $T_{s}$.  Since, in
addition, the number $n$ of points in the image that have to be
filtered in order to land at a point satisfying the swim-criteria is
inversely proportional to $p$, it follows that $n$ is directly
proportional to $T_{s}$.  Thus, when $T_{s}$ is reduced, the time
required to find a point satisfying the swim-criteria is also reduced.
If the image quality were better, however, there would seldom be
islands in the pupil lake, and accordingly an actual pupil point would
be recognized as such more or less independently of $T_{s}$, thus
making the search time independent of $T_{s}$ as well.  Consequently,
when working with ``good'' images, $T_{s}$ should be chosen as high as
possible, preferrably 1, since it would be preferrable to have the
octopus return pupil points as near to the centre of the pupil as
possible, and low values of $T_{s}$ imposes the danger of the octopus
settling with one arm on the ``beach'' of the pupil lake, its hand in
a small pond\footnote{The danger of having small ponds on the shores
  of the pupil lake decreases with the increased image quality.  With
  the given test images, however, this was a common phenomenon.}.

\subsection{The ``Intelligent'' Octopus}
\label{algo:seek:IQ}

One approach to finding a pupil point would be to apply the octopus as
described above to every pixel in the image, say, starting in the
upper left corner (the reference point), until a pupil point had been
detected.  This would, however, not be a very time-efficient solution.
Another approach would be to define a grid covering the image and only
apply the octopus to the grid points, using some strategy as to the
order in which the points are subjected to filtering.  With this
approach, the time needed to detect a pupil point would depend on two
factors: The grid spacing, and the application strategy.  An even
better approach would be to incorporate into the octopus some sort of
mechanism which, from its current location, iteratively moves it in
the most probable direction with respect to finding the pupil lake.
When this direction is found to be the $\vec{0}$ vector, the
swim-criteria are applied to determine whether or not the octopus
swims.  This is the approach taken in {\octopus}, and allegorically it
can be described as the octopus looking for the sea.

\subsubsection{Selecting a Starting Pixel}

In order for the procedure coarsely outlined above to proceed, an
initial point, or {\em starting pixel\/}, from which the octopus
starts looking for the sea, has to be chosen.  The approach taken in
{\octopus} to this problem, is to choose the starting pixel
semi-randomly from a predefined set {\SS} of {\em candidate pixels\/}.
Each time a pixel has been chosen as starting pixel, it is removed
from {\SS}, thus avoiding that the same candidate pixel is chosen
multiple times.  The pixels initially in {\SS} are evenly distributed
over the entire image, and their number depends only on the fraction
of the image occupied by the pupil, and not on the image resolution.
Starting pixels continue to be selected from {\SS} until the lastly
selected starting pixel caused the octopus to report detection of a
pupil point, or until {\SS} is empty.  In the latter case, the pupil
could not be found in the given image, and an error signal is given.
In Section~\ref{algo:seek:strategy}, a detailed description is given
of the semi-random manner in which starting pixels are selected from
{\SS}.

\subsubsection{Determining the Most Probable Direction to the
  Pupil Lake}

\insertepswidth{octoiq}{\label{fig:IQ}The principle behind the
  ``intelligent'' octopus.}{0.5}

From a given pixel in an image, the most probable direction to the
pupil lake is determined by letting the sensors of each arm
successively register whether or not the pixel it covers is wet,
starting at the hand and moving towards the centre (or {\em body\/})
of the octopus, stopping if a wet pixel is detected, or if the body is
reached without having detected any wet pixels.  When a sensor sees a
wet pixel, a {\em pulling force\/} is associated with the arm to which
it belongs, equal to the distance from the sensor to the body of the
octopus.  E.g., if the hand of the north arm covers a wet pixel, a
northward pulling force equal to $r_{o}$ is associated with it.
Otherwise, the sensor next to the hand is made current, and the
procedure is repeated.  Thus, if sensor number 3 from the hand detects
a wet pixel, the pulling force associated with the arm is set to
$r_{o}-3$.  If the body is reached without having detected any wet
pixels, the pulling force associated with the hand is set to zero.
After each arm has had a pulling force associated with it, the octopus
is moved to a new location whose offset relative to the old position
is given by the vector sum of the individual pulling forces.  By using
the pixel of the new location as starting pixel, the above procedure
is repeated until the octopus remains in the same position, that is,
the vector sum of the indvidual pulling forces is zero.  When this is
the case, the swim-criteria are applied to determine whether the
current location corresponds to a pupil point.

The principle is illustrated in Fig.~\ref{fig:IQ}.  Each square
corresponds to a pixel in an image, the shaded region in the lower
part of the figure represents a lake, and the solid cross represents
the octopus in its initial location, with radius $r_{o}=6$.  The north
and west arms are seen to be completely dry, and thus have pulling
forces of zero associated with them.  The south arm has its hand in
the lake, causing a force of 6 ($r_{o}$) to be associated with it,
whereas the east arm becomes a force of 3 associated with it.  The
arrows indicate the strength of the pulling forces.  By forming the
vector sum of the individual forces, the new location is found, and
the octopus is moved, as indicated by the dotted cross.  In the next
iteration all pulling forces are 6, exept the west force, which is 5,
causing the octopus to retain its vertical position and moving one
pixel eastwards, as indicated by the first small arrow; thereafter it
retains its horizontal position and moves one pixel southwards, as
indicated by the second small arrow.  And after that, since the
pulling forces here are the same in all directions, it remains in the
same position, thus causing the swim-criteria to be applied.  As is
evident, they will both be satisfied, since all the sensors detect
wetness, and thus a pupil point has been found.

One thing that has to be considered is the danger of the octopus
starting to jump back and forth between two positions in the image.
This would for instance happen if the lake into which it has jumped is
one pixel to narrow for it to fit, say, vertically.  In this case, it
would alternately have its north and south hand on land, whereas the
other would be in the lake, causing it to enter an infinite loop of
jumping back and forth.  Generally, the danger of this happening is
largest whenever it jumps into a lake that is too small for it to fit
in either direction; it is bound to happen if the east-west or
north-south shore-to-shore distance with respect to its current
location in the lake is smaller than $2r_{o}+1$ and is an even number
of pixels.  To avoid {\octopus} entering an infinite loop like this,
there is an upper limit to the number of jumps the octopus can do
without settling.  In the current implementation, this limit is set to
10.

\subsubsection{Settlement Categories}

There are four categories of locations at which the octopus can
settle.  The first corresponds to the octopus being entirely on dry
land.  That is, none of its sensors detect wetness.  Evidently, this
can only happen if the initial starting position is completely dry,
since once it has detected a lake, it does not fall out of it.  The
second category corresponds to a location where the octopus actually
is on dry land, but has all of its arms crossing small ponds at equal
distances from its body.  A special case of this scenario is when it
has its hands as well as its body in small ponds, but the major part
of its other sensors are dry.  In this case, the first swim/criterion
will be satisfied, thus invoking the second, which causes the location
to be discarded as a pupil point (that is, if $T_{s}$ has been
assigned a reasonable value).  The third category is when it settles
in a lake that is too small for it to fit.  That is, its body is in
the lake, but either two or all of its hands are on land.  Note also
that it is in this case that the danger of entering an infinite loop
as described above is largest.  Evidently, locations belonging to
either of the two first categories will not satisfy the first
swim-criterion, obliterating the need to apply the second.  The last
category is when the octopus jumps into a lake which is large enough
to contain it.  This is the scenario depicted in Fig.~\ref{fig:IQ}.
In this case, the first swim-criterion will always be satisfied, and
the second has to be applied to determine whether or not the given
location corresponds to a pupil point.

\subsection{The Pick Strategy}
\label{algo:seek:strategy}

In the previous section it was said that the pixels in the set {\SS}
of candidate pixels were evenly distributed over the entire image, and
that their number was determined by the fraction of the image occupied
by the pupil, and not by the image resolution.  It was also mentioned
that the points supplied as starting pixels to the ``intelligent''
octopus were selection in a semi-random manner from {\SS}.  Below, the
distribution and selection aspects of the {\em pick strategy\/} are
given separate treatment.

\subsubsection{The Distribution of the Candidate Pixels in the Image}

\insertepswidth{candidat}{\label{fig:candidate}The distribution of the
  candidate pixels of {\SS} in the image.  $r_{p_{min}}$ is the
  minimum pupil radius in pixels.}{0.5}

Basically, the pixels in {\SS} are grid points of a grid superimposed
on the image, whose spacing is equal to the estimated minimum pupil
radius.  However, not all grid points of this grid are candidate
pixels, as shown in Fig.~\ref{fig:candidate}.  For the sake of
clarity, crosses of equal size to the octopus have been superimosed at
each location of a candidate pixel.  As is seen, the spacing between
candidate pixels in each row and column of the grid is twice the
estimated minimum pupil radius $r_{p_{min}}$, and their horizontal and
vertical alignment alternates with an offset of $r_{p_{min}}$ every
second row and column, respectively.  Evidently, since the grid
spacing is equal to the estimated minimum pupil size, the number of
candidate pixels in {\SS} depends only only on the fraction of the
image occupied by the pupil.

Since the neurophysiological experiments, into whose setup {\octopus}
is going to be incorporated, take place in relative darkness, the only
source of visible light being the inducing monitor (cf.\ 
Section~\ref{intro:motivation}), it is clear that the actual radius of
the pupil in the images supplied to {\octopus} will be considerably
larger than the estimated minimum size.  If assuming that the actual
pupil radius will be at least 20\% larger than the estimated
minimum\footnote{In the given test images, the actual pupil radius is
  $\sim 30\%$ larger than the estimated minumum.}, careful examination
of Fig.~\ref{fig:candidate} reveals that the minimum number of
starting pixels that cause the octopus to jump into the pupil lake is
4.  If the image quality is relatively good and the lake level $T_{l}$
is chosen so that the number of islands in the pupil lake is minimal
the probability of the octopus settling in the pupil lake without
recognizing its location as a pupil point is negligible (cf.\ 
Section~\ref{algo:seek:idea}).

\subsubsection{Selecting Starting Pixels}

One approach to selecting starting pixel from {\SS} would be to select
them at complete random.  However, taking into account that in most
cases the pupil occupies the central portion of the image, this would
cause an unnecessary waste of time, in that, on the average, a
relatively large number of peripheral pixels would be supplied as
starting pixels before supplying a central pixel.  Thus, in
{\octopus}, a {\em semi-random\/} selection procedure is employed.
The basis of the procedure is the division of the image plane into
{\em plausibility areas\/}, each of which is assigned a {\em priority
  level\/} according to the probability of its containing the pupil.
The idea is illustrated in Fig.~\ref{fig:plausible}.  

When the search procedure is invoked on an image, the priority level
is set to 1, which corresponds to plausibility area 1 in the figure.
Thus, as long as the priority level is 1 and the corresponding subset
of {\SS} is not empty, starting pixels are selected randomly from this
subset.  If the pupil could not be found in plausibility area 1, the
priority level is incremented, and starting pixels are selected
randomly from plausibility area 2.  Note that plausibility area 1 is a
proper subset of plausibility area 2.  However, since plausibility
area 1 is empty when the priority level is incremented, selections are
only made from the enclosing portion of plausibility area 2.  The
number of plausibility areas can in principle be chosen freely, but is
in the current implementation set to 3, as shown
Fig.~\ref{fig:plausible}.  Each time the subset of {\SS} is empty that
corresponds to the plausibility area given by the current priority
level, the priority level is incremented, and selections are made from
the enclosing plausibility area.  If the subset of {\SS} corresponding
to the outermost plausibility area---{\SS} itself, that is,
corresponding to the entire image---has been emptied without finding
the pupil, the pupil is assumed not to be present in the image, and an
error signal is given.

With the given test images it turned out that, in nearly all cases,
the pupil was found without having to leave plausibility area 1.  In
terms of time consumption, the search algorithm was found to run 4--5
times as fast with plausibility areas as it did when starting pixels
were chosen at complete random.  The effect of the plausibility areas
is that the average image area that has to be searched in order to
detect the pupil is drastically reduced without imposing the danger of
not detecting the pupil if it should happen to be located outside this
area.  Moreover, the average time needed to detect the pupil when
located peripherally in the image is only slightly more than the
average time\footnote{1--2 ms with the given test images.} needed for
general pupil detection without plausibility areas.

\insertepswidth{plausibl}{\label{fig:plausible}The division of the
  image plane into plausible areas.  The gray levels of the areas
  correspond to the probabilities of their containing the pupil.}{0.4}

\subsection{Number of Operations}
\label{algo:seek:O}

If assuming that the fraction of the image occupied by the pupil is
constant, it is clear that the number of candidate pixels in {\SS} is
$O(1)$ (cf.\ Section~\ref{algo:seek:strategy}).  The number of jumps
that the octopus can do from a given starting pixel is limited by a
constant (10 in the current implementation), and is thus also $O(1)$.
The number of operations needed to apply the first swim-criterion at a
location is 5 (cf.\ Section~\ref{algo:seek:octopus}), and accordingly
$O(1)$.  For the second swim-criterion, the number of operations is
proportional to the estimated minimum pupil radius in pixels.
Assuming that the fraction of the image occupied by the pupil is
constant, and that the image is of size $N\times N$ (which is not the
case with the test images), this number is $O(N)$.  The overall number
of operations for the swimming octopus search algorithm as presented
above is thus $O(N)$.
