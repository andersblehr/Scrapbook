\File{eyepos.pas},{11:54},{Apr 12 1993}
\L{\LB{\C{}(\*\*\*}}
\L{\LB{ \*\*\*  eyepos.pas, version 2.3}}
\L{\LB{ \*\*\*}}
\L{\LB{ \*\*\*  Example of how to employ search.pas, version 2.2 or later.}}
\L{\LB{ \*\*\*  The image is supplied as command line parameter, is displayed}}
\L{\LB{ \*\*\*  on the screen, and the pupil position found is marked with a}}
\L{\LB{ \*\*\*  small star in the image.}}
\L{\LB{ \*\*\*}}
\L{\LB{ \*\*\*  Usage:}}
\L{\LB{ \*\*\*}}
\L{\LB{ \*\*\*     eyepos [\-d][\-l\<T\_\{l\}\>][\-o\<r\_\{o\}\>][\-s\<T\_\{e\}\>]}}
\L{\LB{ \*\*\*            [\-w\<T\_\{s\}\>][\-n\<nIterations\>] file[.pic]}}
\L{\LB{ \*\*\*}}
\L{\LB{ \*\*\*  The \-d option causes showSearch to be true and consequently each}}
\L{\LB{ \*\*\*  location in the image to which the Sobel operators are applied}}
\L{\LB{ \*\*\*  will be marked with a white point on the screen.}}
\L{\LB{ \*\*\*)\CE{}}}
\L{\LB{}}
\L{\LB{\Proc{eyePos}\K{program} eyePos;}}
\L{\LB{}}
\L{\LB{\C{}(\*\*}}
\L{\LB{ \*\*  SVGA.pas contains routines for displaying high\-resolution black \&}}
\L{\LB{ \*\*  white images on the screen.  Requires an ET4000 SVGA graphic card.}}
\L{\LB{ \*\*)\CE{}}}
\L{\LB{}}
\L{\LB{\K{uses} crt,dos,graph,auxil,search,SVGA;}}
\L{\LB{}}
\L{\LB{\C{}(\*\*}}
\L{\LB{ \*\*  Variables}}
\L{\LB{ \*\*)\CE{}}}
\L{\LB{}}
\L{\LB{\K{var}}}
\L{\LB{}}
\L{\LB{\C{}(\*}}
\L{\LB{ \*  Variables used to measure the time.}}
\L{\LB{ \*)\CE{}}}
\L{\LB{      startHours                : word;}}
\L{\LB{      startMinutes              : word;}}
\L{\LB{      startSeconds              : word;}}
\L{\LB{      start100thSeconds         : word;}}
\L{\LB{      endHours                  : word;}}
\L{\LB{      endMinutes                : word;}}
\L{\LB{      endSeconds                : word;}}
\L{\LB{      end100thSeconds           : word;}}
\L{\LB{}}
\L{\LB{\C{}(\*}}
\L{\LB{ \*  A pupil point, supplied by findPupilPoint.}}
\L{\LB{ \*)\CE{}}}
\L{\LB{      pupilPoint                : pointType;}}
\L{\LB{}}
\L{\LB{\C{}(\*}}
\L{\LB{ \*  The position of the pupil in the given image.}}
\L{\LB{ \*)\CE{}}}
\L{\LB{      pupilPosition             : pointType;}}
\L{\LB{}}
\L{\LB{\C{}(\*}}
\L{\LB{ \*  Estimate of the time needed to locate the pupil.  Accuracy}}
\L{\LB{ \*  increases when nIterations increases.}}
\L{\LB{ \*)\CE{}}}
\L{\LB{      searchTime                : real;}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\Proc{init}\K{procedure} init;}}
\L{\LB{}}
\L{\LB{\K{var}   fileName                  : string;}}
\L{\LB{      inputFile                 : \K{file};}}
\L{\LB{      buffer                    : bufferType;}}
\L{\LB{      i,j                       : word;}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}(\*}}
\L{\LB{ \*  getParameters}}
\L{\LB{ \*}}
\L{\LB{ \*  Reads and interprets the command line parameters.}}
\L{\LB{ \*)\CE{}}}
\L{\LB{}}
\L{\LB{\Proc{getParameters}  \K{procedure} getParameters(numberOfParameters : word);}}
\L{\LB{}}
\L{\LB{  \K{var}   i                         : byte;}}
\L{\LB{}\Tab{8}{thisParameter             : string;}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\Proc{getParameterValue}    \K{function} getParameterValue(parameterString : string) : real;}}
\L{\LB{}}
\L{\LB{    \K{var}   value                     : real;}}
\L{\LB{}\Tab{8}{  result                    : \K{integer};}}
\L{\LB{}}
\L{\LB{    \K{begin}}}
\L{\LB{      val(copy(parameterString,3,length(parameterString)\-2),value,result);}}
\L{\LB{      \K{if} (result=0) \K{then}}}
\L{\LB{}\Tab{8}{getParameterValue:=value}}
\L{\LB{      \K{else}}}
\L{\LB{}\Tab{8}{fatalError(\S{}\'Illegal parameter value, must be a number!\'\SE{})}}
\L{\LB{    \K{end};}}
\ProcCont{getParameters}\L{\LB{}}
\L{\LB{}}
\L{\LB{  \K{begin}}}
\L{\LB{    \K{for} i:=1 \K{to} numberOfParameters\-1 \K{do}}}
\L{\LB{      \K{begin}}}
\L{\LB{}\Tab{8}{thisParameter:=paramStr(i);}}
\L{\LB{}\Tab{8}{\K{if} (thisParameter[1]=\S{}\'\-\'\SE{}) \K{then}}}
\L{\LB{}\Tab{8}{  \K{case} thisParameter[2] \K{of}}}
\L{\LB{}\Tab{8}{    \S{}\'d\'\SE{} : showSearch:=true;}}
\L{\LB{            \S{}\'l\'\SE{} : lakeLevel:=trunc(getParameterValue(thisParameter));}}
\L{\LB{}\Tab{8}{    \S{}\'o\'\SE{} : octopusRadiusFraction:=getParameterValue(thisParameter);}}
\L{\LB{}\Tab{8}{    \S{}\'s\'\SE{} : sobelThreshold:=trunc(getParameterValue(thisParameter));}}
\L{\LB{            \S{}\'w\'\SE{} : wetFraction:=getParameterValue(thisParameter);}}
\L{\LB{}\Tab{8}{    \S{}\'n\'\SE{} : nIterations:=trunc(getParameterValue(thisParameter))}}
\L{\LB{}\Tab{8}{  \K{else}}}
\L{\LB{}\Tab{8}{    fatalError(\S{}\'Illegal option: \-\'\SE{}+thisParameter[2])}}
\L{\LB{}\Tab{8}{  \K{end}}}
\L{\LB{}\Tab{8}{\K{else}}}
\L{\LB{}\Tab{8}{  fatalError(\S{}\'Cannot specify more than one file: \'\SE{}+thisParameter)}}
\L{\LB{      \K{end};}}
\L{\LB{    fileName:=picturePath(paramStr(numberOfParameters))}}
\L{\LB{  \K{end};}}
\ProcCont{init}\L{\LB{}}
\L{\LB{}}
\L{\LB{\Proc{initVariables}  \K{procedure} initVariables;}}
\L{\LB{}}
\L{\LB{  \K{begin}}}
\L{\LB{    blockRead(inputFile,buffer,4);}}
\L{\LB{    xSize:=(word(buffer[1]) shl 8)+buffer[2];}}
\L{\LB{    ySize:=(word(buffer[3]) shl 8)+buffer[4];}}
\L{\LB{    startX:=round(getMaxX\/2\-xSize\/2);}}
\L{\LB{    startY:=round(getMaxY\/2\-ySize\/2);}}
\L{\LB{    initGlobals}}
\L{\LB{  \K{end};}}
\ProcCont{init}\L{\LB{}}
\L{\LB{}}
\L{\LB{\K{begin}}}
\L{\LB{  \K{if} (paramCount\<\>0) \K{then}}}
\L{\LB{    \K{begin}}}
\L{\LB{      getParameters(paramCount);}}
\L{\LB{      \K{if} fileExists(fileName) \K{then}}}
\L{\LB{}\Tab{8}{\K{begin}}}
\L{\LB{}\Tab{8}{  SVGA\_initGraphics(mode800x600);}}
\L{\LB{}\Tab{8}{  SVGA\_setBlackAndWhitePalette;}}
\L{\LB{          assign(inputFile,fileName);}}
\L{\LB{          reset(inputFile,1);}}
\L{\LB{}\Tab{8}{  initVariables;}}
\L{\LB{}\Tab{8}{  getMem(image,4\*ySize);}}
\L{\LB{}\Tab{8}{  \K{for} i:=1 \K{to} ySize \K{do}}}
\L{\LB{}\Tab{8}{    \K{begin}}}
\L{\LB{}\Tab{8}{      blockRead(inputFile,buffer,xSize);}}
\L{\LB{}\Tab{8}{      getMem(image\^[i],xSize);}}
\L{\LB{\C{}(\*}}
\L{\LB{ \*  Initializes the in\-memory image and displays it on the screen.}}
\L{\LB{ \*)\CE{}}}
\L{\LB{}\Tab{8}{      \K{for} j:=1 \K{to} xSize \K{do}}}
\L{\LB{}\Tab{16}{\K{begin}}}
\L{\LB{}\Tab{16}{  image\^[i]\^[j]:=buffer[j];}}
\L{\LB{}\Tab{16}{  putPixel(startX+j\-1,startY+i\-1,buffer[j])}}
\L{\LB{}\Tab{16}{\K{end}}}
\L{\LB{}\Tab{8}{    \K{end};}}
\L{\LB{}\Tab{8}{  close(inputFile);}}
\L{\LB{}\Tab{8}{  rectangle(startX,startY,startX+xSize,startY+ySize)}}
\L{\LB{}\Tab{8}{\K{end}}}
\L{\LB{      \K{else}}}
\L{\LB{}\Tab{8}{fatalError(\S{}\'Image file not found: \'\SE{}+picturePath(fileName))}}
\L{\LB{    \K{end}}}
\L{\LB{  \K{else}}}
\L{\LB{    fatalError(\S{}\'Usage: eyepos [\-dlonsw] file[.pic]\'\SE{})}}
\L{\LB{\K{end};}}
\ProcCont{eyePos}\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}(\*}}
\L{\LB{ \*  findPupilPosition}}
\L{\LB{ \*}}
\L{\LB{ \*  Finds the pupil and computes the time needed.}}
\L{\LB{ \*)\CE{}}}
\L{\LB{}}
\L{\LB{\Proc{findPupilPosition}\K{procedure} findPupilPosition;}}
\L{\LB{}}
\L{\LB{\K{var}   i                         : word;}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\Proc{sec100ths}  \K{function} sec100ths : real;}}
\L{\LB{}}
\L{\LB{  \K{begin}}}
\L{\LB{    sec100ths:=(6000\*(endMinutes     \-startMinutes)+}}
\L{\LB{}\Tab{16}{ 100\*(endSeconds     \-startSeconds)+}}
\L{\LB{}\Tab{16}{     (end100thSeconds\-start100thSeconds))\/}}
\L{\LB{}\Tab{8}{       (nIterations\/10)}}
\L{\LB{  \K{end};}}
\ProcCont{findPupilPosition}\L{\LB{}}
\L{\LB{}}
\L{\LB{\K{begin}}}
\L{\LB{  \K{if} findPupilPoint(pupilPoint) \K{then}}}
\L{\LB{    \K{begin}}}
\L{\LB{      getTime(startHours,startMinutes,startSeconds,start100thSeconds);}}
\L{\LB{      \K{for} i:=1 \K{to} nIterations \K{do}}}
\L{\LB{        \K{begin}}}
\L{\LB{          findPupilPoint(pupilPoint);}}
\L{\LB{          findPosition(pupilPoint,pupilPosition)}}
\L{\LB{        \K{end};}}
\L{\LB{      getTime(endHours,endMinutes,endSeconds,end100thSeconds);}}
\L{\LB{      searchTime:=sec100ths}}
\L{\LB{    \K{end}}}
\L{\LB{  \K{else}}}
\L{\LB{    fatalError(\S{}\'No pupil was found!\'\SE{});}}
\L{\LB{  markPosition(pupilPosition.x,pupilPosition.y,asStar)}}
\L{\LB{\K{end};}}
\ProcCont{eyePos}\L{\LB{}}
\L{\LB{}}
\L{\LB{\Proc{writeData}\K{procedure} writeData;}}
\L{\LB{}}
\L{\LB{\K{begin}}}
\L{\LB{  setTextStyle(defaultFont,horizDir,1);}}
\L{\LB{  setTextJustify(leftText,centerText);}}
\L{\LB{  setColor(60);}}
\L{\LB{  outTextXY(startX,startY+ySize+30,\S{}\'Position         : (\'\SE{}+}}
\L{\LB{}\Tab{8}{    intString(pupilPosition.x)+\S{}\',\'\SE{}+intString(pupilPosition.y)+\S{}\')\'\SE{});}}
\L{\LB{  outTextXY(startX,startY+ySize+40,\S{}\'Search time (ms) : \'\SE{}+}}
\L{\LB{}\Tab{8}{    realString(searchTime))}}
\L{\LB{\K{end};}}
\ProcCont{eyePos}\L{\LB{}}
\L{\LB{}}
\L{\LB{\Proc{finishOff}\K{procedure} finishOff;}}
\L{\LB{}}
\L{\LB{\K{begin}}}
\L{\LB{  closeSearch;}}
\L{\LB{  readKey;}}
\L{\LB{  closeGraph}}
\L{\LB{\K{end};}}
\ProcCont{eyePos}\L{\LB{}}
\L{\LB{}}
\L{\LB{\K{begin}}}
\L{\LB{  init;}}
\L{\LB{  findPupilPosition;}}
\L{\LB{  writeData;}}
\L{\LB{  finishOff}}
\L{\LB{\K{end}.}}
